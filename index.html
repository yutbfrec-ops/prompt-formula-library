<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <title>Prompt Formula Libraryï¼ˆæç¤ºè©å…¬å¼åº«ï¼‰ï½œPro / Lite é›™æ¨¡å¼</title>
  <style>
    :root{
      --bg:#F6F5F3;
      --panel:#ffffff;
      --muted:#6f675f;
      --text:#1f1a17;
      --brand:#994785;
      --brand-strong:#7f3569;
      --accent:#E0D9D3;
      --line:rgba(80,68,60,.16);
      --chip:#f4efea;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:20px;
      --shadow: 0 18px 40px rgba(35,25,18,.08);
      --shadow-soft: 0 10px 24px rgba(35,25,18,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: "Noto Sans TC", "Inter", system-ui, -apple-system, "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 12% -10%, rgba(153,71,133,.16), transparent 60%),
        radial-gradient(800px 600px at 90% 0%, rgba(153,71,133,.08), transparent 50%),
        var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:36px 24px 64px}
    .top{
      position:relative;
      display:flex;gap:20px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:56px 48px;border:1px solid rgba(153,71,133,.18);
      background:linear-gradient(135deg, #ffffff 0%, #f6f0ec 55%, #efe6eb 100%);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top::before{
      content:"";
      position:absolute;inset:auto -20% -40% 40%;
      height:240px;
      background:radial-gradient(circle at center, rgba(153,71,133,.22), transparent 70%);
      opacity:.7;
      pointer-events:none;
    }
    .top::after{
      content:"";
      position:absolute;inset:20px;
      border:1px dashed rgba(153,71,133,.15);
      border-radius: calc(var(--radius) + 6px);
      pointer-events:none;
    }
    .brand{display:flex;flex-direction:column;gap:10px;max-width:520px}
    .brand h1{margin:0;font-size:32px;letter-spacing:.6px;line-height:1.3}
    .brand .sub{color:var(--muted);font-size:15px;line-height:1.6}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end;z-index:1}
    .btn{
      border:1px solid rgba(153,71,133,.22);
      background:#fff;
      color:var(--text);
      padding:10px 16px;border-radius:14px;cursor:pointer;
      font-size:14px;font-weight:600;display:inline-flex;gap:8px;align-items:center;
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
      box-shadow:0 6px 18px rgba(35,25,18,.08);
    }
    .btn:hover{border-color:rgba(153,71,133,.45);transform:translateY(-1px)}
    .btn:active{transform:translateY(1px);box-shadow:0 3px 10px rgba(35,25,18,.12)}
    .btn.primary{
      border-color:transparent;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand-strong) 100%);
      color:#fff;box-shadow:0 10px 22px rgba(153,71,133,.25);
    }
    .btn.primary:hover{box-shadow:0 14px 28px rgba(153,71,133,.3)}
    .btn .dot{width:8px;height:8px;border-radius:99px;background:var(--brand);display:inline-block}
    .row{display:flex;gap:20px;margin-top:32px;align-items:stretch;flex-wrap:wrap}
    .panel{
      border:1px solid rgba(153,71,133,.12);
      background:var(--panel);border-radius:var(--radius);
      box-shadow: var(--shadow-soft);overflow:hidden;
      animation:fadeUp .7s ease both;
    }
    .left{flex:1 1 320px;min-width:300px}
    .right{flex:2 1 520px;min-width:320px}
    .toolbar{padding:18px;border-bottom:1px solid var(--accent);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .search{
      flex:1 1 260px;min-width:240px;display:flex;align-items:center;gap:8px;
      border:1px solid rgba(153,71,133,.18);background:#fbf8f5;
      padding:10px 12px;border-radius:12px;
    }
    .search input{
      width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:14px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 12px;border-radius:999px;border:1px solid rgba(153,71,133,.18);
      background:#faf7f4;color:var(--muted);font-size:12px;cursor:pointer;
      transition:all .18s ease;
    }
    .tab.active{color:var(--text);border-color:rgba(153,71,133,.5);background:rgba(153,71,133,.08)}
    .list{max-height:62vh;overflow:auto}
    .card{
      padding:18px;border-bottom:1px solid rgba(224,217,211,.8);cursor:pointer;
      transition:background .2s ease;
    }
    .card:hover{background:rgba(153,71,133,.05)}
    .card.active{background:rgba(153,71,133,.08)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .card .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);border:1px solid rgba(153,71,133,.12);color:var(--muted);font-size:11px;padding:4px 8px;border-radius:999px}
    .chip.pack{color:#725267;border-color:rgba(153,71,133,.24)}
    .chip.tag{color:#44635a;border-color:rgba(110,164,150,.2)}
    .code{font-size:11px;color:var(--muted)}
    /* Lite æ¨¡å¼ï¼šéš±è—æŠ€è¡“æ¨™ç±¤ï¼Œé¿å…è³‡è¨Šå™ªéŸ³ */
    .wrap[data-mode="lite"] .chip,
    .wrap[data-mode="lite"] .code,
    .wrap[data-mode="lite"] .pro-only{display:none}
    .wrap[data-mode="pro"] .lite-only{display:none}
    .segmented{
      display:inline-flex;border:1px solid rgba(153,71,133,.25);border-radius:999px;overflow:hidden;
      background:#f5efea;
    }
    .segmented button{
      border:none;background:transparent;color:var(--muted);padding:8px 16px;cursor:pointer;font-size:12px;
    }
    .segmented button.active{color:var(--text);background:rgba(153,71,133,.16)}
    .info-card{
      margin-top:18px;border:1px solid rgba(153,71,133,.12);border-radius:18px;padding:18px;
      background:#faf7f5;display:grid;gap:12px;
    }
    .info-card h3{margin:0;font-size:15px}
    .info-card p{margin:0;color:var(--muted);font-size:14px;line-height:1.6}
    .example-list{display:flex;gap:10px;flex-wrap:wrap}
    .example-btn{
      border:1px dashed rgba(153,71,133,.4);background:#fff;color:var(--text);
      padding:8px 12px;border-radius:12px;font-size:12px;cursor:pointer;
      transition:all .18s ease;
    }
    .example-btn:hover{border-color:rgba(153,71,133,.7);transform:translateY(-1px)}
    .content{padding:28px}
    .title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title h2{margin:0;font-size:24px}
    .title p{margin:6px 0 0 0;color:var(--muted);font-size:14px;line-height:1.55}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:18px}
    .field{border:1px solid rgba(153,71,133,.12);background:#fbf8f5;border-radius:16px;padding:14px}
    .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:8px}
    .field input,.field textarea{
      width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:14px;line-height:1.5;
      font-family:var(--sans);
    }
    .field textarea{min-height:90px;resize:vertical}
    .outwrap{margin-top:18px}
    .outhead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .outhead .hint{color:var(--muted);font-size:13px}
    pre{
      margin:12px 0 0 0;padding:16px;border:1px solid rgba(153,71,133,.15);border-radius:16px;background:#f7f2ee;
      overflow:auto;white-space:pre-wrap;word-break:break-word;font-family:var(--mono);font-size:12.5px;line-height:1.6;
    }
    .toast{
      position:fixed;right:20px;bottom:20px;max-width:420px;
      padding:12px 16px;border:1px solid rgba(153,71,133,.35);border-radius:14px;background:#fff8fb;
      box-shadow: var(--shadow-soft);color:var(--text);display:none;
    }
    .toast.show{display:block}
    .status{
      margin:16px 0 0 0;padding:12px 14px;border:1px dashed rgba(153,71,133,.35);
      background:#fbf6f9;border-radius:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      color:var(--muted);font-size:13px;
    }
    .status strong{color:var(--text);font-weight:600}
    .status.hidden{display:none}
    .status .btn{padding:6px 10px;font-size:12px;box-shadow:none}
    .debug{
      margin-top:12px;border-top:1px solid var(--accent);padding-top:12px;color:var(--muted);font-size:12px;line-height:1.6;
    }
    .debug strong{color:var(--text)}

    /* ä½ç›¸å®¹æ€§è¤‡è£½å‚™æ´ï¼šå½ˆçª—è®“ä½¿ç”¨è€…é•·æŒ‰è¤‡è£½ */
    .modal{position:fixed;inset:0;background:rgba(31,26,23,.45);display:none;align-items:center;justify-content:center;z-index:120}
    .modal.show{display:flex}
    .modal .box{width:min(760px,92vw);max-height:80vh;overflow:auto;border:1px solid rgba(153,71,133,.2);background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:20px}
    .modal .box h3{margin:0 0 8px 0;font-size:16px}
    .modal .box textarea{width:100%;min-height:240px;border:1px solid rgba(153,71,133,.15);border-radius:12px;background:#fbf8f5;color:var(--text);padding:12px;font-family:var(--mono);font-size:12.5px;line-height:1.5}
    .modal .box .row{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--accent);margin:18px 0}
    .footer{margin-top:18px;color:var(--muted);font-size:12px;line-height:1.6}
    .kbd{font-family:var(--mono);font-size:11px;color:#5b4a43;background:#f5efea;border:1px solid rgba(153,71,133,.2);padding:2px 6px;border-radius:8px}
    .fold{border:1px dashed rgba(153,71,133,.25);border-radius:14px;padding:12px;background:#faf7f4}
    .fold summary{cursor:pointer;font-size:12px;color:var(--muted);list-style:none}
    .key-hints{margin:8px 0 0 18px;color:var(--muted);font-size:12px;line-height:1.6}
    .checklist{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:10px}
    .check-item{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
    .guide-steps{margin:8px 0 0 0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.6}
    .guide-steps li{margin-bottom:6px}

    @keyframes fadeUp{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app" data-mode="pro">
    <div class="top">
      <div class="brand">
        <h1>Prompt Formula Libraryï¼ˆæç¤ºè©å…¬å¼åº«ï¼‰ï½œPro / Lite é›™æ¨¡å¼</h1>
        <div class="sub">æ–°æ‰‹ç”¨ Lite å¿«é€Ÿä¸Šæ‰‹ï¼›å°ˆå®¶ç”¨ Pro ä¿ç•™å®Œæ•´æ¬„ä½èˆ‡æŠ€å·§æç¤º</div>
        <div class="small" id="metaLine">Prompt Formula Libraryï¼ˆæç¤ºè©å…¬å¼åº«ï¼‰ï½œPro / Lite é›™æ¨¡å¼</div>
      </div>
      <div class="actions">
        <div class="segmented" role="group" aria-label="æ¨¡å¼åˆ‡æ›">
          <button type="button" class="seg-btn" data-mode="lite">Lite</button>
          <button type="button" class="seg-btn" data-mode="pro">Pro</button>
        </div>
        <button class="btn" id="btnQuickStart">å¿«é€Ÿä¸Šæ‰‹</button>
        <details class="btn" style="padding:0">
          <summary class="btn" style="list-style:none;user-select:none">è³‡æ–™</summary>
          <div style="position:absolute;right:0;margin-top:8px;min-width:220px;z-index:50">
            <div class="panel" style="padding:10px">
              <div class="small" style="margin-bottom:10px">åŒ¯å…¥/åŒ¯å‡ºä½ çš„è‡ªè¨‚ prompts.json</div>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="btnExport"><span class="dot"></span>åŒ¯å‡º</button>
                <button class="btn" id="btnImport">åŒ¯å…¥</button>
                <button class="btn" id="btnReset">é‡ç½®æœ¬åœ°</button>
              </div>
              <div class="debug" id="debugPanel">
                <div><strong>prompts.json</strong>ï¼š<span id="debugFetch">â€”</span></div>
                <div><strong>æ¨¡æ¿æ•¸é‡</strong>ï¼š<span id="debugCount">â€”</span></div>
                <div><strong>æœ€å¾ŒéŒ¯èª¤</strong>ï¼š<span id="debugError">â€”</span></div>
                <div><strong>Lite copy</strong>ï¼š<span id="debugCopyLite">â€”</span></div>
                <div><strong>Pro copy</strong>ï¼š<span id="debugCopyPro">â€”</span></div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="row">
      <div class="panel left">
        <div class="toolbar">
          <div class="search">
            <span class="small">ğŸ”</span>
            <input id="q" placeholder="æœå°‹ï¼šç”Ÿæ—¥ç¥ç¦ / é‚€è«‹ / æ„Ÿè¬ / è²¼æ–‡â€¦" />
          </div>
          <div class="tabs" id="tabs"></div>
        </div>
        <div class="list" id="list"></div>
      </div>

      <div class="panel right">
        <div class="content">
          <div class="title">
            <div>
              <h2 id="pTitle">è¼‰å…¥ä¸­â€¦</h2>
              <p id="pTeaser"></p>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnCopy">è¤‡è£½ï¼šè²¼åˆ° ChatGPT/LLM</button>
              <button class="btn" id="btnCopyRaw">è¤‡è£½æ¨¡æ¿ï¼ˆä¸æ›¿æ›ï¼‰</button>
            </div>
          </div>
          <div class="info-card" id="infoCard">
            <div>
              <h3>é€™å€‹æ¨¡æ¿å¯ä»¥å¹«ä½ åšä»€éº¼</h3>
              <p id="purposeText">â€”</p>
            </div>
            <div>
              <div class="small" style="margin-bottom:6px">ç”Ÿæ´»ä¾‹å­ï¼ˆé»ä¸€ä¸‹ç›´æ¥å¡«å…¥ï¼‰</div>
              <div class="example-list" id="exampleList"></div>
            </div>
          </div>
          <div class="status" id="statusBar">
            <strong id="statusText">è¼‰å…¥ä¸­â€¦</strong>
            <button class="btn" id="btnRetry">é‡è©¦</button>
          </div>

          <div class="grid" id="vars"></div>

          <div class="outwrap">
            <div class="outhead">
              <div class="hint">è¼¸å‡ºé è¦½ï¼ˆæœƒå¥—ç”¨ä½ å¡«çš„å…§å®¹ï¼‰</div>
              <div class="small pro-only">å°æŠ€å·§ï¼šè®“ AI å…ˆå•ä½ å¹¾å€‹å•é¡Œï¼Œæˆ–åŠ ä¸Šè¦å‰‡ï¼Œé€šå¸¸æœƒæ›´ç©©å®šã€‚</div>
            </div>
            <ol class="guide-steps lite-only">
              <li>1) æŒ‰ã€Œè¤‡è£½ï¼šè²¼åˆ° ChatGPT/LLMã€â†’ è²¼åˆ° ChatGPT/Gemini ç”¢ç”Ÿçµæœ</li>
              <li>2) æŠŠçµæœè²¼å› LINE/Email/è²¼åœ–å·¥å…·ä½¿ç”¨</li>
            </ol>
            <pre id="out"></pre>
            <div class="small lite-only" style="margin-top:8px">æŠŠ LLM ç”Ÿæˆçš„çµæœï¼Œå†è²¼åˆ° LINE/Email/è²¼åœ–å·¥å…·</div>
          </div>

          <div class="divider"></div>
          <div class="footer">
            <div>éƒ¨ç½²åˆ° GitHub Pagesï¼šæŠŠ <span class="kbd">index.html</span> + <span class="kbd">prompts.json</span> æ”¾åˆ° repo æ ¹ç›®éŒ„ â†’ Settings â†’ Pages â†’ Deployã€‚</div>
            <div>æœ¬é æœƒå„ªå…ˆè®€å–æœ¬åœ° localStorage çš„è³‡æ–™ï¼›è‹¥ç„¡ï¼Œæ‰è®€å– prompts.jsonã€‚</div>
            <details class="fold" style="margin-top:10px">
              <summary>Debug è³‡è¨Š</summary>
              <div class="debug">
                <div><strong>ç›®å‰æ¨¡å¼</strong>ï¼š<span id="debugMode">â€”</span></div>
                <div><strong>prompts è¼‰å…¥ä¾†æº</strong>ï¼š<span id="debugSource">â€”</span></div>
                <div><strong>prompts æ•¸é‡</strong>ï¼š<span id="debugCountSimple">â€”</span></div>
              </div>
            </details>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="copyModal" aria-hidden="true">
      <div class="box">
        <h3>ä½ çš„ç€è¦½å™¨ä¸å…è¨±è‡ªå‹•è¤‡è£½</h3>
        <div class="small">åšæ³•ï¼šé•·æŒ‰ä¸‹æ–¹æ–‡å­— â†’ å…¨é¸ â†’ è¤‡è£½ï¼ˆæˆ–æŒ‰ã€Œå…¨é¸ã€å†è¤‡è£½ï¼‰</div>
        <textarea id="fallbackCopyArea" readonly></textarea>
        <div class="row">
          <button class="btn" id="btnSelectAll">å…¨é¸</button>
          <button class="btn primary" id="btnCloseModal">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="modal" id="quickModal" aria-hidden="true">
      <div class="box">
        <h3>å¿«é€Ÿä¸Šæ‰‹ï¼ˆ3 æ­¥é©Ÿï¼‰</h3>
        <ol class="guide-steps">
          <li>é¸ä¸€å€‹æƒ…å¢ƒæ¨¡æ¿ï¼Œå¡« 2â€“3 å€‹æ¬„ä½ï¼ˆçœ‹ä¸åˆ°çš„å¯å…ˆç•¥éï¼‰ã€‚</li>
          <li>æŒ‰ã€Œè¤‡è£½ï¼šè²¼åˆ° ChatGPT/LLMã€ï¼ˆPro åŒæ¨£ï¼‰æˆ–ã€Œè¤‡è£½æ¨¡æ¿ï¼ˆä¸æ›¿æ›ï¼‰ã€ã€‚</li>
          <li>è²¼åˆ° ChatGPT / Geminiï¼ŒæŒ‰é€å‡ºã€‚</li>
        </ol>
        <div class="row">
          <button class="btn primary" id="btnCloseQuick">çŸ¥é“äº†</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <input type="file" id="fileInput" accept="application/json" style="display:none" />
  </div>

<script>
(() => {
  const LS_KEY = "pfl_prompts_json_v1";
  const UI_MODE_KEY = "pfl_ui_mode";
  const LOAD_TIMEOUT_MS = 2500;

  const el = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  };

  const state = {
    data: null,
    activePack: "ALL",
    activeId: null,
    query: "",
    values: {},
    uiMode: (localStorage.getItem(UI_MODE_KEY) || "pro"),
  };
  const debugState = {
    fetchStatus: "idle",
    promptSource: "â€”",
    promptCount: 0,
    lastError: "â€”",
  };

  const BASIC_FIELDS = {
    "A-GAF": { primary: ["task", "audience"], advanced: ["format", "constraints"] },
    "A-Q3": { primary: ["task", "output"], advanced: ["context"] },
    "A-TLDR": { primary: ["topic"], advanced: ["audience", "constraints"] },
    "A-Table": { primary: ["question", "items"], advanced: ["columns"] },
    "A-Constraints": { primary: ["task", "must"], advanced: ["must_not", "format", "input"] },
    "A-RoleAudience": { primary: ["topic", "audiences"], advanced: ["role", "constraints"] },
    "A-Critique": { primary: ["draft", "goal"], advanced: ["constraints"] },
    "A-Decision": { primary: ["context", "options"], advanced: ["criteria"] },
  };
  const CONSTRAINT_PRESETS = [
    "çŸ­ä¸€é»",
    "æ›´æœ‰ç¦®è²Œ",
    "ä¸è¦æµ®èª‡",
    "çµ¦ 3 ç‰ˆ",
    "åŠ  emoji",
  ];
  const LITE_LABELS = {
    task: "æˆ‘è¦åšä»€éº¼",
    audience: "çµ¦èª°çœ‹ï¼ˆå°è±¡ï¼‰",
    format: "æˆ‘æƒ³è¦çš„æ¨£å­ï¼ˆä¾‹å¦‚ï¼šä¸€å¥è©±/ä¸€æ®µ/æ¢åˆ—/å¡ç‰‡å¼ï¼‰",
    constraints: "ä¸è¦å‡ºç¾ä»€éº¼ï¼ˆå¯é¸ï¼‰",
  };

  const normalize = (s) => (s || "").toString().toLowerCase();

  function updateDebug() {
    const fetchEl = el("debugFetch");
    const countEl = el("debugCount");
    const errEl = el("debugError");
    const modeEl = el("debugMode");
    const sourceEl = el("debugSource");
    const simpleCountEl = el("debugCountSimple");
    if (fetchEl) fetchEl.textContent = debugState.fetchStatus;
    if (countEl) countEl.textContent = String(debugState.promptCount ?? 0);
    if (errEl) errEl.textContent = debugState.lastError || "â€”";
    if (modeEl) modeEl.textContent = state.uiMode === "pro" ? "Pro" : "Lite";
    if (sourceEl) sourceEl.textContent = debugState.promptSource || "â€”";
    if (simpleCountEl) simpleCountEl.textContent = String(debugState.promptCount ?? 0);
  }

  function setStatus(message, showRetry = false) {
    const bar = el("statusBar");
    const textEl = el("statusText");
    const retry = el("btnRetry");
    if (!bar || !textEl) return;
    textEl.textContent = message;
    bar.classList.toggle("hidden", !message);
    if (retry) retry.style.display = showRetry ? "inline-flex" : "none";
  }

  function compileTemplate(tpl, values) {
    return (tpl || "").replace(/\{\{(\w+)\}\}/g, (_, k) => (values[k] ?? ""));
  }

  function packsFromData(data) {
    const set = new Set((data?.prompts || []).map(p => p.pack).filter(Boolean));
    const packs = Array.from(set).sort();
    return ["ALL", ...packs];
  }

  function renderTabs() {
    const tabs = el("tabs");
    if (!tabs) return;
    tabs.innerHTML = "";
    for (const p of packsFromData(state.data)) {
      const b = document.createElement("button");
      b.className = "tab" + (state.activePack === p ? " active" : "");
      b.textContent = p === "ALL" ? "å…¨éƒ¨" : ("Pack " + p);
      b.onclick = () => { state.activePack = p; renderList(); };
      tabs.appendChild(b);
    }
  }

  function promptMatches(p) {
    const q = normalize(state.query);
    if (!q) return true;
    const hay = [
      p.id, p.title, p.teaser,
      ...(p.tags || []),
      ...(p.variables || []).map(v => v.key),
      ...(p.variables || []).map(v => v.label),
    ].map(normalize).join(" ");
    return hay.includes(q);
  }

  function renderList() {
    const list = el("list");
    if (!list) return;
    list.innerHTML = "";

    const items = (state.data?.prompts || [])
      .filter(p => state.activePack === "ALL" ? true : p.pack === state.activePack)
      .filter(promptMatches);

    if (!items.length) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<div class="small">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ¨¡æ¿ã€‚æ›å€‹é—œéµå­—è©¦è©¦ã€‚</div>`;
      list.appendChild(div);
      return;
    }

    for (const p of items) {
      const div = document.createElement("div");
      div.className = "card" + (state.activeId === p.id ? " active" : "");
      div.onclick = () => setActive(p.id);
      div.innerHTML = `
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta">
          <span class="chip pack">Pack ${escapeHtml(p.pack || "-")}</span>
          ${(p.tags || []).slice(0,4).map(t => `<span class="chip tag">#${escapeHtml(t)}</span>`).join("")}
          <span class="code" title="å…¬å¼ä»£è™Ÿ">${escapeHtml(p.id)}</span>
        </div>
      `;
      list.appendChild(div);
    }
  }

  function setActive(id) {
    const p = (state.data?.prompts || []).find(x => x.id === id);
    if (!p) return;
    state.activeId = id;

    // initialize values
    const next = {};
    for (const v of (p.variables || [])) next[v.key] = state.values[v.key] ?? "";
    state.values = next;

    const titleEl = el("pTitle");
    const teaserEl = el("pTeaser");
    if (titleEl) titleEl.textContent = p.title;
    if (teaserEl) teaserEl.textContent = p.teaser || "";
    renderInfo(p);
    renderVars();
    renderOut();
    renderList();
  }

  function createField(v, options = {}) {
    const wrap = document.createElement("div");
    wrap.className = "field";
    const isLong = (v.placeholder || "").length > 45 || ["draft", "items", "input", "options"].includes(v.key);
    const keyHint = (state.uiMode === "pro") ? ` <span class="small">ï¼ˆ${escapeHtml(v.key)}ï¼‰</span>` : "";
    const liteLabel = LITE_LABELS[v.key];
    const resolvedLabel = options.label || (state.uiMode === "lite" && liteLabel ? liteLabel : v.label);
    wrap.innerHTML = `
      <label>${escapeHtml(resolvedLabel)}${keyHint}</label>
      ${isLong
        ? `<textarea data-key="${escapeHtml(v.key)}" placeholder="${escapeHtml(v.placeholder || "")}"></textarea>`
        : `<input data-key="${escapeHtml(v.key)}" placeholder="${escapeHtml(v.placeholder || "")}" />`
      }
    `;
    return wrap;
  }

  function renderConstraintQuick(vars, vMap) {
    const wrap = document.createElement("div");
    wrap.className = "field";
    const mustKey = vMap.must?.key || "must";
    wrap.innerHTML = `
      <label>å¸¸ç”¨é™åˆ¶ï¼ˆå¯å‹¾é¸/å¯ç·¨è¼¯ï¼‰</label>
      <div class="checklist">
        ${CONSTRAINT_PRESETS.map((label, idx) => `
          <label class="check-item">
            <input type="checkbox" data-preset="${idx}" />
            ${escapeHtml(label)}
          </label>
        `).join("")}
      </div>
      <textarea data-key="${escapeHtml(mustKey)}" placeholder="${escapeHtml(vMap.must?.placeholder || "")}"></textarea>
      <div class="small" style="margin-top:6px">å¯ç›´æ¥æ”¹å¯«ï¼Œä¸Šé¢å‹¾é¸åªæ˜¯ä¸€å€‹å¿«é€Ÿèµ·æ‰‹å¼ã€‚</div>
    `;
    vars.appendChild(wrap);

    const textarea = wrap.querySelector(`textarea[data-key="${mustKey}"]`);
    if (textarea) {
      textarea.value = state.values[mustKey] ?? "";
      textarea.addEventListener("input", () => {
        state.values[mustKey] = textarea.value;
        renderOut();
      });
    }
    wrap.querySelectorAll("input[type=\"checkbox\"]").forEach((cb) => {
      cb.addEventListener("change", () => {
        const selections = [];
        wrap.querySelectorAll("input[type=\"checkbox\"]").forEach((c, idx) => {
          if (c.checked) selections.push(CONSTRAINT_PRESETS[idx]);
        });
        const next = selections.join("ï¼›");
        state.values[mustKey] = next;
        if (textarea) textarea.value = next;
        renderOut();
      });
    });
  }

  function renderVars() {
    const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
    const vars = el("vars");
    if (!vars) return;
    vars.innerHTML = "";
    if (!p) return;

    const vMap = {};
    for (const v of (p.variables || [])) vMap[v.key] = v;

    const isBasic = state.uiMode === "lite";
    const config = BASIC_FIELDS[p.id] || {};
    const primaryKeys = config.primary || (p.variables || []).map(v => v.key);
    const advancedKeys = config.advanced || [];

    if (!isBasic) {
      for (const v of (p.variables || [])) vars.appendChild(createField(v));
    } else {
      for (const key of primaryKeys) {
        const v = vMap[key];
        if (!v) continue;
        if (p.id === "A-Constraints" && key === "must") {
          renderConstraintQuick(vars, vMap);
          continue;
        }
        vars.appendChild(createField(v, { label: p.id === "A-TLDR" && key === "topic" ? "ä¸»é¡Œ/è¦é»" : v.label }));
      }
      if (advancedKeys.length) {
        const fold = document.createElement("details");
        fold.className = "fold";
        fold.innerHTML = `<summary>å±•é–‹æ›´å¤š</summary>`;
        const inner = document.createElement("div");
        inner.className = "grid";
        for (const key of advancedKeys) {
          const v = vMap[key];
          if (!v) continue;
          inner.appendChild(createField(v));
        }
        fold.appendChild(inner);
        vars.appendChild(fold);
      }

      const hintFold = document.createElement("details");
      hintFold.className = "fold";
      hintFold.innerHTML = `<summary>é€²éšæç¤º</summary>`;
      const hintList = document.createElement("ul");
      hintList.className = "key-hints";
      for (const v of (p.variables || [])) {
        const liteLabel = LITE_LABELS[v.key];
        const label = liteLabel || v.label;
        const item = document.createElement("li");
        item.innerHTML = `${escapeHtml(label)} <span class="small">ï¼ˆ${escapeHtml(v.key)}ï¼‰</span>`;
        hintList.appendChild(item);
      }
      hintFold.appendChild(hintList);
      vars.appendChild(hintFold);
    }

    // bind values
    vars.querySelectorAll("input,textarea").forEach(inp => {
      const k = inp.getAttribute("data-key");
      if (!k) return;
      inp.value = state.values[k] ?? "";
      inp.addEventListener("input", () => {
        state.values[k] = inp.value;
        renderOut();
      });
    });
  }

  function renderInfo(p) {
    const purposeText = el("purposeText");
    const exampleList = el("exampleList");
    if (purposeText) purposeText.textContent = p?.teaser || "â€”";
    if (!exampleList) return;
    exampleList.innerHTML = "";
    const examples = p?.examples || [];
    if (!examples.length) {
      const empty = document.createElement("div");
      empty.className = "small";
      empty.textContent = "æš«ç„¡ç”Ÿæ´»ä¾‹å­";
      exampleList.appendChild(empty);
      return;
    }
    for (const example of examples.slice(0, 2)) {
      const btn = document.createElement("button");
      btn.className = "example-btn";
      btn.textContent = example.label || "å¥—ç”¨ä¾‹å­";
      btn.onclick = () => {
        const next = {};
        for (const v of (p.variables || [])) {
          next[v.key] = example.values?.[v.key] ?? "";
        }
        state.values = next;
        renderVars();
        renderOut();
      };
      exampleList.appendChild(btn);
    }
  }

  function applyLitePreamble(template) {
    const litePreamble = "è«‹ä¾æˆ‘å¡«çš„å…§å®¹ï¼Œç›´æ¥ç”¢å‡ºå¯ä½¿ç”¨çš„æˆå“ã€‚è‹¥è³‡è¨Šä¸è¶³ï¼Œå…ˆå•æˆ‘ 2 å€‹å•é¡Œå†é–‹å§‹ã€‚\n\n";
    const lines = (template || "").split("\n");
    const firstLine = (lines[0] || "").trim();
    const shouldSwap = firstLine
      && !firstLine.includes("{{")
      && !firstLine.includes("ï¼š")
      && /[ã€‚ï¼ï¼Ÿ]$/.test(firstLine);
    if (shouldSwap) {
      return `${litePreamble}${lines.slice(1).join("\n")}`;
    }
    return `${litePreamble}${template || ""}`;
  }

  function getOutputText(mode, prompt, values) {
    const template = prompt?.template || "";
    const baseTemplate = mode === "lite" ? applyLitePreamble(template) : template;
    const base = compileTemplate(baseTemplate, values).trim();
    if (mode !== "lite") return base;
    return base;
  }

  function renderOut() {
    const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
    if (!p) return;
    const out = el("out");
    if (out) out.textContent = getOutputText(state.uiMode, p, state.values);
    updateCopyDiagnostics(p);
  }
  
  function truncatePreview(text, max = 120) {
    if (!text) return "â€”";
    return text.length > max ? `${text.slice(0, max)}â€¦` : text;
  }

  function updateCopyDiagnostics(p) {
    const liteCopyEl = el("debugCopyLite");
    const proCopyEl = el("debugCopyPro");
    if (!liteCopyEl && !proCopyEl) return;
    const liteText = p ? getOutputText("lite", p, state.values) : "";
    const proText = p ? getOutputText("pro", p, state.values) : "";
    if (liteCopyEl) liteCopyEl.textContent = truncatePreview(liteText);
    if (proCopyEl) proCopyEl.textContent = truncatePreview(proText);
  }

  function validateData(obj) {
    if (!obj || !Array.isArray(obj.prompts)) {
      throw new Error("prompts.json æ ¼å¼ä¸æ­£ç¢º");
    }
    return obj;
  }

  async function loadData() {
    // local storage first
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      try {
        const parsed = validateData(JSON.parse(saved));
        return { data: parsed, source: "localStorage" };
      } catch (e) { /* ignore */ }
    }
    // fallback to prompts.json
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), LOAD_TIMEOUT_MS);
    try {
      const r = await fetch("./prompts.json", { cache: "no-store", signal: controller.signal });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const json = await r.json();
      return { data: validateData(json), source: "prompts.json" };
    } finally {
      clearTimeout(timeout);
    }
  }

  function persistData() {
    localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  }

  function openCopyModal(text) {
    const modal = el("copyModal");
    const area = el("fallbackCopyArea");
    area.value = text;
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
    // ç›¡é‡è‡ªå‹•é¸å–ï¼Œè®“ä½¿ç”¨è€…ä¸€éµé•·æŒ‰/è¤‡è£½
    setTimeout(() => {
      area.focus();
      area.select();
    }, 60);
  }

  function copyText(text) {
    // clipboard API åœ¨éå®‰å…¨ç’°å¢ƒï¼ˆä¾‹å¦‚ http + å…§ç¶² IPï¼‰å¸¸æœƒè¢«ç¦ç”¨
    const canClipboard = !!(navigator.clipboard && window.isSecureContext);

    const fallbackCopy = () => {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-1000px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        if (ok) {
          toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        } else {
          toast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
          openCopyModal(text);
        }
      } catch (e) {
        toast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
        openCopyModal(text);
      }
    };

    if (!canClipboard) {
      fallbackCopy();
      return;
    }

    try {
      navigator.clipboard.writeText(text)
        .then(() => toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
        .catch(() => fallbackCopy());
    } catch (e) {
      fallbackCopy();
    }
  }

  // event wiring
  const searchInput = el("q");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      state.query = e.target.value || "";
      renderList();
    });
  }

  const btnCopy = el("btnCopy");
  if (btnCopy) {
    btnCopy.onclick = () => {
      const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
      if (!p) return;
      copyText(getOutputText(state.uiMode, p, state.values));
    };
  }

  const btnCopyRaw = el("btnCopyRaw");
  if (btnCopyRaw) {
    btnCopyRaw.onclick = () => {
      const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
      if (!p) return;
      copyText(p.template);
    };
  }

  const btnExport = el("btnExport");
  if (btnExport) {
    btnExport.onclick = () => {
      const text = JSON.stringify(state.data, null, 2);
      download("prompts.json", text);
      toast("å·²åŒ¯å‡º prompts.json");
    };
  }

  const btnImport = el("btnImport");
  if (btnImport) {
    btnImport.onclick = () => el("fileInput")?.click();
  }

  const fileInput = el("fileInput");
  if (fileInput) {
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj || !Array.isArray(obj.prompts)) throw new Error("Invalid format");
        state.data = obj;
        persistData();
        initUI();
        toast("å·²åŒ¯å…¥ä¸¦å„²å­˜åˆ°æœ¬åœ°");
      } catch (err) {
        toast("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèªæ˜¯ prompts.json");
      } finally {
        el("fileInput").value = "";
      }
    });
  }

  const btnResetLocal = el("btnReset");
  if (btnResetLocal) {
    btnResetLocal.onclick = () => {
      localStorage.removeItem(LS_KEY);
      toast("å·²æ¸…é™¤æœ¬åœ°è³‡æ–™ï¼Œé‡æ–°è¼‰å…¥ prompts.json");
      setTimeout(() => location.reload(), 400);
    };
  }

  function setMode(mode) {
    const m = (mode === "pro") ? "pro" : "lite";
    state.uiMode = m;
    localStorage.setItem(UI_MODE_KEY, m);
    el("app").setAttribute("data-mode", m);
    document.querySelectorAll(".seg-btn").forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.mode === m);
    });
    const copyBtn = el("btnCopy");
    if (copyBtn) copyBtn.textContent = "è¤‡è£½ï¼šè²¼åˆ° ChatGPT/LLM";
    // é‡æ–°æ¸²æŸ“ï¼Œè®“æ¬„ä½æ¨™ç¤ºè·Ÿè‘—è®ŠåŒ–
    if (state.activeId) setActive(state.activeId);
    renderList();
    updateDebug();
  }
  document.querySelectorAll(".seg-btn").forEach((btn) => {
    btn.addEventListener("click", () => setMode(btn.dataset.mode));
  });

  // è¤‡è£½å¤±æ•—å‚™æ´å½ˆçª—ï¼ˆç‰¹åˆ¥æ˜¯ Android / é HTTPS / å…§ç¶² IPï¼‰
  const btnCloseModal = el("btnCloseModal");
  if (btnCloseModal) {
    btnCloseModal.onclick = () => {
      const modal = el("copyModal");
      if (!modal) return;
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    };
  }
  const btnSelectAll = el("btnSelectAll");
  if (btnSelectAll) {
    btnSelectAll.onclick = () => {
      const ta = el("fallbackCopyArea");
      if (!ta) return;
      ta.focus();
      ta.select();
      toast("å·²å…¨é¸ï¼Œè«‹é»ã€è¤‡è£½ã€æˆ–é•·æŒ‰è¤‡è£½");
    };
  }

  function initUI() {
    setMode(state.uiMode);
    const metaLine = el("metaLine");
    if (metaLine) metaLine.textContent = "Prompt Formula Libraryï¼ˆæç¤ºè©å…¬å¼åº«ï¼‰ï½œPro / Lite é›™æ¨¡å¼";
    renderTabs();
    // default active: first prompt
    const first = (state.data?.prompts || [])[0];
    state.activePack = "ALL";
    state.activeId = first?.id || null;
    renderList();
    if (state.activeId) setActive(state.activeId);
  }

  function resetViewForLoading() {
    const list = el("list");
    const vars = el("vars");
    const out = el("out");
    const tabs = el("tabs");
    const title = el("pTitle");
    const teaser = el("pTeaser");
    if (list) list.innerHTML = "";
    if (vars) vars.innerHTML = "";
    if (out) out.textContent = "";
    if (tabs) tabs.innerHTML = "";
    if (title) title.textContent = "è¼‰å…¥ä¸­â€¦";
    if (teaser) teaser.textContent = "";
  }

  async function boot() {
    resetViewForLoading();
    debugState.fetchStatus = "loading";
    debugState.lastError = "â€”";
    debugState.promptCount = 0;
    debugState.promptSource = "â€”";
    updateDebug();
    setStatus("è¼‰å…¥ä¸­â€¦", false);

    let localWarning = "";
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      try {
        validateData(JSON.parse(saved));
      } catch (e) {
        localWarning = "æœ¬åœ°è³‡æ–™æå£ï¼Œå·²æ”¹è®€ prompts.json";
      }
    }

    try {
      const result = await loadData();
      state.data = result.data;
      debugState.fetchStatus = `ok (${result.source})`;
      debugState.promptSource = result.source;
      debugState.promptCount = (state.data?.prompts || []).length;
      if (localWarning) debugState.lastError = localWarning;
      updateDebug();
      if (localWarning) toast(localWarning);

      if (!debugState.promptCount) {
        setStatus("æ‰¾ä¸åˆ°ä»»ä½•æ¨¡æ¿ã€‚ä½ å¯ä»¥æŒ‰ã€ŒåŒ¯å…¥ã€è¼‰å…¥ prompts.jsonï¼Œæˆ–æŒ‰é‡è©¦ã€‚", true);
        return;
      }

      initUI();
      setStatus("", false);
    } catch (err) {
      const isAbort = err?.name === "AbortError";
      const message = isAbort
        ? "è®€å–é€¾æ™‚ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ–å¿«å–å•é¡Œï¼‰ï¼Œè«‹æŒ‰é‡è©¦ã€‚"
        : `è®€å–å¤±æ•—ï¼š${err?.message || "æœªçŸ¥éŒ¯èª¤"}ï¼ˆå¯æŒ‰é‡è©¦ï¼‰`;
      debugState.fetchStatus = "error";
      debugState.lastError = err?.message || String(err);
      updateDebug();
      setStatus(message, true);
      const title = el("pTitle");
      const teaser = el("pTeaser");
      if (title) title.textContent = "è®€å–å¤±æ•—";
      if (teaser) teaser.textContent = "";
    }
  }

  const btnRetry = el("btnRetry");
  if (btnRetry) {
    btnRetry.onclick = () => boot();
  }

  const btnQuickStart = el("btnQuickStart");
  if (btnQuickStart) {
    btnQuickStart.onclick = () => {
      const modal = el("quickModal");
      if (!modal) return;
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
    };
  }
  const btnCloseQuick = el("btnCloseQuick");
  if (btnCloseQuick) {
    btnCloseQuick.onclick = () => {
      const modal = el("quickModal");
      if (!modal) return;
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    boot();
  });
})();
</script>
</body>
</html>
