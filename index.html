<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æç¤ºè©å…¬å¼åº«ï¼ˆv0.1.1 Pack Aï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111824; --muted:#7f8ea3; --text:#e8eef7;
      --brand:#7dd3fc; --line:#1f2a3a; --chip:#172133; --ok:#34d399;
      --warn:#fbbf24; --bad:#fb7185;
      --radius:16px;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:radial-gradient(1200px 800px at 10% 0%, rgba(125,211,252,.12), transparent 55%), var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .top{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:18px;border:1px solid var(--line);background:rgba(17,24,36,.82);backdrop-filter: blur(10px);
      border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .brand{display:flex;flex-direction:column;gap:6px}
    .brand h1{margin:0;font-size:20px;letter-spacing:.2px}
    .brand .sub{color:var(--muted);font-size:13px;line-height:1.3}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn{
      border:1px solid var(--line);background:linear-gradient(180deg, rgba(23,33,51,.9), rgba(17,24,36,.9));
      color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;
      font-size:13px;display:inline-flex;gap:8px;align-items:center;
    }
    .btn:hover{border-color:#2b3a52}
    .btn.primary{border-color:rgba(125,211,252,.55);box-shadow:0 0 0 1px rgba(125,211,252,.15) inset}
    .btn .dot{width:8px;height:8px;border-radius:99px;background:var(--brand);display:inline-block}
    .row{display:flex;gap:14px;margin-top:16px;align-items:stretch;flex-wrap:wrap}
    .panel{
      border:1px solid var(--line);background:rgba(17,24,36,.72);border-radius:var(--radius);
      box-shadow: var(--shadow);overflow:hidden;
    }
    .left{flex:1 1 320px;min-width:300px}
    .right{flex:2 1 520px;min-width:320px}
    .toolbar{padding:14px;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search{
      flex:1 1 260px;min-width:240px;display:flex;align-items:center;gap:8px;
      border:1px solid var(--line);background:rgba(11,15,20,.55);
      padding:10px 12px;border-radius:12px;
    }
    .search input{
      width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:14px;
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(11,15,20,.45);color:var(--muted);font-size:12px;cursor:pointer;
    }
    .tab.active{color:var(--text);border-color:rgba(125,211,252,.55);background:rgba(125,211,252,.10)}
    .list{max-height:62vh;overflow:auto}
    .card{
      padding:14px;border-bottom:1px solid var(--line);cursor:pointer;
    }
    .card:hover{background:rgba(125,211,252,.05)}
    .card.active{background:rgba(125,211,252,.08)}
    .card h3{margin:0 0 6px 0;font-size:14px}
    .card .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.05);color:var(--muted);font-size:11px;padding:4px 8px;border-radius:999px}
    .chip.pack{color:#c7d2fe;border-color:rgba(199,210,254,.18)}
    .chip.tag{color:#a7f3d0;border-color:rgba(167,243,208,.15)}
    /* æ–°æ‰‹æ¨¡å¼ï¼šéš±è—æŠ€è¡“æ¨™ç±¤ï¼Œé¿å…è³‡è¨Šå™ªéŸ³ */
    .wrap[data-mode="basic"] .chip{display:none}
    .content{padding:16px}
    .title{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .title h2{margin:0;font-size:18px}
    .title p{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}
    .field{border:1px solid var(--line);background:rgba(11,15,20,.45);border-radius:14px;padding:12px}
    .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:8px}
    .field input,.field textarea{
      width:100%;border:none;outline:none;background:transparent;color:var(--text);font-size:13px;line-height:1.35;
      font-family:var(--sans);
    }
    .field textarea{min-height:82px;resize:vertical}
    .outwrap{margin-top:12px}
    .outhead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .outhead .hint{color:var(--muted);font-size:12px}
    pre{
      margin:10px 0 0 0;padding:14px;border:1px solid var(--line);border-radius:14px;background:rgba(11,15,20,.55);
      overflow:auto;white-space:pre-wrap;word-break:break-word;font-family:var(--mono);font-size:12.5px;line-height:1.45;
    }
    .toast{
      position:fixed;right:16px;bottom:16px;max-width:420px;
      padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:rgba(17,24,36,.92);
      box-shadow: var(--shadow);color:var(--text);display:none;
    }
    .toast.show{display:block}
    .status{
      margin:12px 0 0 0;padding:10px 12px;border:1px dashed rgba(125,211,252,.35);
      background:rgba(15,23,42,.55);border-radius:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      color:var(--muted);font-size:13px;
    }
    .status strong{color:var(--text);font-weight:600}
    .status.hidden{display:none}
    .status .btn{padding:6px 10px;font-size:12px}
    .debug{
      margin-top:10px;border-top:1px solid var(--line);padding-top:10px;color:var(--muted);font-size:12px;line-height:1.5;
    }
    .debug strong{color:var(--text)}

    /* ä½ç›¸å®¹æ€§è¤‡è£½å‚™æ´ï¼šå½ˆçª—è®“ä½¿ç”¨è€…é•·æŒ‰è¤‡è£½ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120}
    .modal.show{display:flex}
    .modal .box{width:min(760px,92vw);max-height:80vh;overflow:auto;border:1px solid var(--line);background:rgba(17,24,36,.96);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .modal .box h3{margin:0 0 8px 0;font-size:14px}
    .modal .box textarea{width:100%;min-height:240px;border:1px solid var(--line);border-radius:12px;background:rgba(11,15,20,.55);color:var(--text);padding:12px;font-family:var(--mono);font-size:12.5px;line-height:1.45}
    .modal .box .row{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px}
    .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .footer{margin-top:16px;color:var(--muted);font-size:12px;line-height:1.4}
    .kbd{font-family:var(--mono);font-size:11px;color:#cbd5e1;background:rgba(11,15,20,.6);border:1px solid rgba(255,255,255,.06);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap" id="app" data-mode="basic">
    <div class="top">
      <div class="brand">
        <h1>æç¤ºè©å…¬å¼åº«</h1>
        <div class="sub">å¡« 2â€“3 æ ¼ â†’ è¤‡è£½ â†’ è²¼åˆ° ChatGPT / Gemini / ä»»ä½• AI å·¥å…·</div>
        <div class="small" id="metaLine"></div>
      </div>
      <div class="actions">
        <button class="btn primary" id="btnMode">æ–°æ‰‹æ¨¡å¼ï¼šé–‹</button>
        <details class="btn" style="padding:0">
          <summary class="btn" style="list-style:none;user-select:none">è³‡æ–™</summary>
          <div style="position:absolute;right:0;margin-top:8px;min-width:220px;z-index:50">
            <div class="panel" style="padding:10px">
              <div class="small" style="margin-bottom:10px">åŒ¯å…¥/åŒ¯å‡ºä½ çš„è‡ªè¨‚ prompts.json</div>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="btnExport"><span class="dot"></span>åŒ¯å‡º</button>
                <button class="btn" id="btnImport">åŒ¯å…¥</button>
                <button class="btn" id="btnReset">é‡ç½®æœ¬åœ°</button>
              </div>
              <div class="debug" id="debugPanel">
                <div><strong>prompts.json</strong>ï¼š<span id="debugFetch">â€”</span></div>
                <div><strong>æ¨¡æ¿æ•¸é‡</strong>ï¼š<span id="debugCount">â€”</span></div>
                <div><strong>æœ€å¾ŒéŒ¯èª¤</strong>ï¼š<span id="debugError">â€”</span></div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="row">
      <div class="panel left">
        <div class="toolbar">
          <div class="search">
            <span class="small">ğŸ”</span>
            <input id="q" placeholder="æœå°‹ï¼šGAF / TL;DR / è¡¨æ ¼ / é™åˆ¶ / å¯©ç¨¿â€¦" />
          </div>
          <div class="tabs" id="tabs"></div>
        </div>
        <div class="list" id="list"></div>
      </div>

      <div class="panel right">
        <div class="content">
          <div class="title">
            <div>
              <h2 id="pTitle">è¼‰å…¥ä¸­â€¦</h2>
              <p id="pTeaser"></p>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnCopy">ä¸€éµ Copy</button>
              <button class="btn" id="btnCopyRaw">è¤‡è£½æ¨¡æ¿ï¼ˆä¸æ›¿æ›ï¼‰</button>
            </div>
          </div>
          <div class="status" id="statusBar">
            <strong id="statusText">è¼‰å…¥ä¸­â€¦</strong>
            <button class="btn" id="btnRetry">é‡è©¦</button>
          </div>

          <div class="grid" id="vars"></div>

          <div class="outwrap">
            <div class="outhead">
              <div class="hint">è¼¸å‡ºé è¦½ï¼ˆæœƒç”¨ä½ å¡«çš„è®Šæ•¸æ›¿æ› <span class="kbd">{{variable}}</span>ï¼‰</div>
              <div class="small">å°æŠ€å·§ï¼šå…ˆç”¨ <span class="kbd">Q3</span>ï¼ˆå…ˆå•å•é¡Œï¼‰æˆ– <span class="kbd">é™åˆ¶åŒ…</span>ï¼Œå¯æ§åº¦æœƒå¤§å¹…ä¸Šå‡</div>
            </div>
            <pre id="out"></pre>
          </div>

          <div class="divider"></div>
          <div class="footer">
            <div>éƒ¨ç½²åˆ° GitHub Pagesï¼šæŠŠ <span class="kbd">index.html</span> + <span class="kbd">prompts.json</span> æ”¾åˆ° repo æ ¹ç›®éŒ„ â†’ Settings â†’ Pages â†’ Deployã€‚</div>
            <div>æœ¬é æœƒå„ªå…ˆè®€å–æœ¬åœ° localStorage çš„è³‡æ–™ï¼›è‹¥ç„¡ï¼Œæ‰è®€å– prompts.jsonã€‚</div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="copyModal" aria-hidden="true">
      <div class="box">
        <h3>ä½ çš„ç€è¦½å™¨ä¸å…è¨±è‡ªå‹•è¤‡è£½</h3>
        <div class="small">åšæ³•ï¼šé•·æŒ‰ä¸‹æ–¹æ–‡å­— â†’ å…¨é¸ â†’ è¤‡è£½ï¼ˆæˆ–æŒ‰ã€Œå…¨é¸ã€å†è¤‡è£½ï¼‰</div>
        <textarea id="fallbackCopyArea" readonly></textarea>
        <div class="row">
          <button class="btn" id="btnSelectAll">å…¨é¸</button>
          <button class="btn primary" id="btnCloseModal">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <input type="file" id="fileInput" accept="application/json" style="display:none" />
  </div>

<script>
(() => {
  const LS_KEY = "pfl_prompts_json_v1";
  const LOAD_TIMEOUT_MS = 2500;

  const el = (id) => document.getElementById(id);
  const toast = (msg) => {
    const t = el("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  };

  const state = {
    data: null,
    activePack: "ALL",
    activeId: null,
    query: "",
    values: {},
    uiMode: (localStorage.getItem("pfl_ui_mode") || "basic"),
  };
  const debugState = {
    fetchStatus: "idle",
    promptCount: 0,
    lastError: "â€”",
  };

  const normalize = (s) => (s || "").toString().toLowerCase();

  function updateDebug() {
    const fetchEl = el("debugFetch");
    const countEl = el("debugCount");
    const errEl = el("debugError");
    if (fetchEl) fetchEl.textContent = debugState.fetchStatus;
    if (countEl) countEl.textContent = String(debugState.promptCount ?? 0);
    if (errEl) errEl.textContent = debugState.lastError || "â€”";
  }

  function setStatus(message, showRetry = false) {
    const bar = el("statusBar");
    const textEl = el("statusText");
    const retry = el("btnRetry");
    if (!bar || !textEl) return;
    textEl.textContent = message;
    bar.classList.toggle("hidden", !message);
    if (retry) retry.style.display = showRetry ? "inline-flex" : "none";
  }

  function compileTemplate(tpl, values) {
    return (tpl || "").replace(/\{\{(\w+)\}\}/g, (_, k) => (values[k] ?? ""));
  }

  function packsFromData(data) {
    const set = new Set((data?.prompts || []).map(p => p.pack).filter(Boolean));
    const packs = Array.from(set).sort();
    return ["ALL", ...packs];
  }

  function renderTabs() {
    const tabs = el("tabs");
    if (!tabs) return;
    tabs.innerHTML = "";
    for (const p of packsFromData(state.data)) {
      const b = document.createElement("button");
      b.className = "tab" + (state.activePack === p ? " active" : "");
      b.textContent = p === "ALL" ? "å…¨éƒ¨" : ("Pack " + p);
      b.onclick = () => { state.activePack = p; renderList(); };
      tabs.appendChild(b);
    }
  }

  function promptMatches(p) {
    const q = normalize(state.query);
    if (!q) return true;
    const hay = [
      p.id, p.title, p.teaser,
      ...(p.tags || []),
      ...(p.variables || []).map(v => v.key),
      ...(p.variables || []).map(v => v.label),
    ].map(normalize).join(" ");
    return hay.includes(q);
  }

  function renderList() {
    const list = el("list");
    if (!list) return;
    list.innerHTML = "";

    const items = (state.data?.prompts || [])
      .filter(p => state.activePack === "ALL" ? true : p.pack === state.activePack)
      .filter(promptMatches);

    if (!items.length) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `<div class="small">æ‰¾ä¸åˆ°ç¬¦åˆçš„æ¨¡æ¿ã€‚æ›å€‹é—œéµå­—è©¦è©¦ã€‚</div>`;
      list.appendChild(div);
      return;
    }

    for (const p of items) {
      const div = document.createElement("div");
      div.className = "card" + (state.activeId === p.id ? " active" : "");
      div.onclick = () => setActive(p.id);
      div.innerHTML = `
        <h3>${escapeHtml(p.title)}</h3>
        <div class="meta">
          <span class="chip pack">Pack ${escapeHtml(p.pack || "-")}</span>
          ${(p.tags || []).slice(0,4).map(t => `<span class="chip tag">#${escapeHtml(t)}</span>`).join("")}
          <span class="chip">${escapeHtml(p.id)}</span>
        </div>
      `;
      list.appendChild(div);
    }
  }

  function setActive(id) {
    const p = (state.data?.prompts || []).find(x => x.id === id);
    if (!p) return;
    state.activeId = id;

    // initialize values
    const next = {};
    for (const v of (p.variables || [])) next[v.key] = state.values[v.key] ?? "";
    state.values = next;

    const titleEl = el("pTitle");
    const teaserEl = el("pTeaser");
    if (titleEl) titleEl.textContent = p.title;
    if (teaserEl) teaserEl.textContent = p.teaser || "";
    renderVars();
    renderOut();
    renderList();
  }

  function renderVars() {
    const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
    const vars = el("vars");
    if (!vars) return;
    vars.innerHTML = "";
    if (!p) return;

    for (const v of (p.variables || [])) {
      const wrap = document.createElement("div");
      wrap.className = "field";
      const isLong = (v.placeholder || "").length > 45 || v.key === "draft" || v.key === "items" || v.key === "input";
      const keyHint = (state.uiMode === "pro") ? ` <span class="small">ï¼ˆ${escapeHtml(v.key)}ï¼‰</span>` : "";
      wrap.innerHTML = `
        <label>${escapeHtml(v.label)}${keyHint}</label>
        ${isLong
          ? `<textarea data-key="${escapeHtml(v.key)}" placeholder="${escapeHtml(v.placeholder || "")}"></textarea>`
          : `<input data-key="${escapeHtml(v.key)}" placeholder="${escapeHtml(v.placeholder || "")}" />`
        }
      `;
      vars.appendChild(wrap);
    }

    // bind values
    vars.querySelectorAll("input,textarea").forEach(inp => {
      const k = inp.getAttribute("data-key");
      inp.value = state.values[k] ?? "";
      inp.addEventListener("input", () => {
        state.values[k] = inp.value;
        renderOut();
      });
    });
  }

  function renderOut() {
    const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
    if (!p) return;
    const out = el("out");
    if (out) out.textContent = compileTemplate(p.template, state.values);
  }

  function validateData(obj) {
    if (!obj || !Array.isArray(obj.prompts)) {
      throw new Error("prompts.json æ ¼å¼ä¸æ­£ç¢º");
    }
    return obj;
  }

  async function loadData() {
    // local storage first
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      try {
        const parsed = validateData(JSON.parse(saved));
        return { data: parsed, source: "localStorage" };
      } catch (e) { /* ignore */ }
    }
    // fallback to prompts.json
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), LOAD_TIMEOUT_MS);
    try {
      const r = await fetch("./prompts.json", { cache: "no-store", signal: controller.signal });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const json = await r.json();
      return { data: validateData(json), source: "prompts.json" };
    } finally {
      clearTimeout(timeout);
    }
  }

  function persistData() {
    localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  }

  function openCopyModal(text) {
    const modal = el("copyModal");
    const area = el("fallbackCopyArea");
    area.value = text;
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden", "false");
    // ç›¡é‡è‡ªå‹•é¸å–ï¼Œè®“ä½¿ç”¨è€…ä¸€éµé•·æŒ‰/è¤‡è£½
    setTimeout(() => {
      area.focus();
      area.select();
    }, 60);
  }

  function copyText(text) {
    // clipboard API åœ¨éå®‰å…¨ç’°å¢ƒï¼ˆä¾‹å¦‚ http + å…§ç¶² IPï¼‰å¸¸æœƒè¢«ç¦ç”¨
    const canClipboard = !!(navigator.clipboard && window.isSecureContext);

    const fallbackCopy = () => {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.top = "-1000px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        if (ok) {
          toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        } else {
          openCopyModal(text);
        }
      } catch (e) {
        openCopyModal(text);
      }
    };

    if (!canClipboard) {
      fallbackCopy();
      return;
    }

    try {
      navigator.clipboard.writeText(text)
        .then(() => toast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
        .catch(() => fallbackCopy());
    } catch (e) {
      fallbackCopy();
    }
  }

  // event wiring
  const searchInput = el("q");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      state.query = e.target.value || "";
      renderList();
    });
  }

  const btnCopy = el("btnCopy");
  if (btnCopy) {
    btnCopy.onclick = () => {
      const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
      if (!p) return;
      copyText(compileTemplate(p.template, state.values));
    };
  }

  const btnCopyRaw = el("btnCopyRaw");
  if (btnCopyRaw) {
    btnCopyRaw.onclick = () => {
      const p = (state.data?.prompts || []).find(x => x.id === state.activeId);
      if (!p) return;
      copyText(p.template);
    };
  }

  const btnExport = el("btnExport");
  if (btnExport) {
    btnExport.onclick = () => {
      const text = JSON.stringify(state.data, null, 2);
      download("prompts.json", text);
      toast("å·²åŒ¯å‡º prompts.json");
    };
  }

  const btnImport = el("btnImport");
  if (btnImport) {
    btnImport.onclick = () => el("fileInput")?.click();
  }

  const fileInput = el("fileInput");
  if (fileInput) {
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj || !Array.isArray(obj.prompts)) throw new Error("Invalid format");
        state.data = obj;
        persistData();
        initUI();
        toast("å·²åŒ¯å…¥ä¸¦å„²å­˜åˆ°æœ¬åœ°");
      } catch (err) {
        toast("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèªæ˜¯ prompts.json");
      } finally {
        el("fileInput").value = "";
      }
    });
  }

  const btnResetLocal = el("btnReset");
  if (btnResetLocal) {
    btnResetLocal.onclick = () => {
      localStorage.removeItem(LS_KEY);
      toast("å·²æ¸…é™¤æœ¬åœ°è³‡æ–™ï¼Œé‡æ–°è¼‰å…¥ prompts.json");
      setTimeout(() => location.reload(), 400);
    };
  }

  function setMode(mode) {
    const m = (mode === "pro") ? "pro" : "basic";
    state.uiMode = m;
    localStorage.setItem("pfl_ui_mode", m);
    el("app").setAttribute("data-mode", m);
    el("btnMode").textContent = (m === "basic") ? "æ–°æ‰‹æ¨¡å¼ï¼šé–‹" : "æ–°æ‰‹æ¨¡å¼ï¼šé—œ";
    // é‡æ–°æ¸²æŸ“ï¼Œè®“æ¬„ä½æ¨™ç¤ºè·Ÿè‘—è®ŠåŒ–
    if (state.activeId) setActive(state.activeId);
    renderList();
  }

  const btnMode = el("btnMode");
  if (btnMode) {
    btnMode.onclick = () => {
      setMode(state.uiMode === "basic" ? "pro" : "basic");
    };
  }

  // è¤‡è£½å¤±æ•—å‚™æ´å½ˆçª—ï¼ˆç‰¹åˆ¥æ˜¯ Android / é HTTPS / å…§ç¶² IPï¼‰
  const btnCloseModal = el("btnCloseModal");
  if (btnCloseModal) {
    btnCloseModal.onclick = () => {
      const modal = el("copyModal");
      if (!modal) return;
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
    };
  }
  const btnSelectAll = el("btnSelectAll");
  if (btnSelectAll) {
    btnSelectAll.onclick = () => {
      const ta = el("fallbackCopyArea");
      if (!ta) return;
      ta.focus();
      ta.select();
      toast("å·²å…¨é¸ï¼Œè«‹é»ã€è¤‡è£½ã€æˆ–é•·æŒ‰è¤‡è£½");
    };
  }

  function initUI() {
    setMode(state.uiMode);
    const meta = state.data?.meta || {};
    const metaLine = el("metaLine");
    if (metaLine) metaLine.textContent = `è³‡æ–™ï¼š${meta.name || "â€”"}ï½œç‰ˆæœ¬ï¼š${meta.version || "â€”"}ï½œPackï¼š${meta.pack || "â€”"}`;
    renderTabs();
    // default active: first prompt
    const first = (state.data?.prompts || [])[0];
    state.activePack = "ALL";
    state.activeId = first?.id || null;
    renderList();
    if (state.activeId) setActive(state.activeId);
  }

  function resetViewForLoading() {
    const list = el("list");
    const vars = el("vars");
    const out = el("out");
    const tabs = el("tabs");
    const title = el("pTitle");
    const teaser = el("pTeaser");
    if (list) list.innerHTML = "";
    if (vars) vars.innerHTML = "";
    if (out) out.textContent = "";
    if (tabs) tabs.innerHTML = "";
    if (title) title.textContent = "è¼‰å…¥ä¸­â€¦";
    if (teaser) teaser.textContent = "";
  }

  async function boot() {
    resetViewForLoading();
    debugState.fetchStatus = "loading";
    debugState.lastError = "â€”";
    debugState.promptCount = 0;
    updateDebug();
    setStatus("è¼‰å…¥ä¸­â€¦", false);

    let localWarning = "";
    const saved = localStorage.getItem(LS_KEY);
    if (saved) {
      try {
        validateData(JSON.parse(saved));
      } catch (e) {
        localWarning = "æœ¬åœ°è³‡æ–™æå£ï¼Œå·²æ”¹è®€ prompts.json";
      }
    }

    try {
      const result = await loadData();
      state.data = result.data;
      debugState.fetchStatus = `ok (${result.source})`;
      debugState.promptCount = (state.data?.prompts || []).length;
      if (localWarning) debugState.lastError = localWarning;
      updateDebug();
      if (localWarning) toast(localWarning);

      if (!debugState.promptCount) {
        setStatus("æ‰¾ä¸åˆ°ä»»ä½•æ¨¡æ¿ã€‚ä½ å¯ä»¥æŒ‰ã€ŒåŒ¯å…¥ã€è¼‰å…¥ prompts.jsonï¼Œæˆ–æŒ‰é‡è©¦ã€‚", true);
        return;
      }

      initUI();
      setStatus("", false);
    } catch (err) {
      const isAbort = err?.name === "AbortError";
      const message = isAbort
        ? "è®€å–é€¾æ™‚ï¼ˆå¯èƒ½æ˜¯ç¶²è·¯æˆ–å¿«å–å•é¡Œï¼‰ï¼Œè«‹æŒ‰é‡è©¦ã€‚"
        : `è®€å–å¤±æ•—ï¼š${err?.message || "æœªçŸ¥éŒ¯èª¤"}ï¼ˆå¯æŒ‰é‡è©¦ï¼‰`;
      debugState.fetchStatus = "error";
      debugState.lastError = err?.message || String(err);
      updateDebug();
      setStatus(message, true);
      const title = el("pTitle");
      const teaser = el("pTeaser");
      if (title) title.textContent = "è®€å–å¤±æ•—";
      if (teaser) teaser.textContent = "";
    }
  }

  const btnRetry = el("btnRetry");
  if (btnRetry) {
    btnRetry.onclick = () => boot();
  }

  document.addEventListener("DOMContentLoaded", () => {
    boot();
  });
})();
</script>
</body>
</html>
